// Add cards to table
var memoryEntity = document.querySelector("#table");
var card1 = document.createElement("a-entity");
var card2 = document.createElement("a-entity");
var card3 = document.createElement("a-entity");
var card4 = document.createElement("a-entity");
var card5 = document.createElement("a-entity");
var card6 = document.createElement("a-entity");
var card7 = document.createElement("a-entity");
var card8 = document.createElement("a-entity");
var card9 = document.createElement("a-entity");
var card10 = document.createElement("a-entity");
var card11 = document.createElement("a-entity");
var card12 = document.createElement("a-entity");
var card13 = document.createElement("a-entity");
var card14 = document.createElement("a-entity");
var card15 = document.createElement("a-entity");
var card16 = document.createElement("a-entity");

AFRAME.utils.entity.setComponentProperty(card1, "position", {x: 0, y: 0.5, z: 0});
AFRAME.utils.entity.setComponentProperty(card1, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card1, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card1, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card2, "position", {x: 0, y: 0.52, z: 0});
AFRAME.utils.entity.setComponentProperty(card2, "rotation", {x: 0, y: 2, z: 0});
AFRAME.utils.entity.setComponentProperty(card2, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card2, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card2, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card3, "position", {x: 0, y: 0.54, z: 0});
AFRAME.utils.entity.setComponentProperty(card3, "rotation", {x: 0, y: 4, z: 0});
AFRAME.utils.entity.setComponentProperty(card3, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card3, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card3, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card4, "position", {x: 0, y: 0.56, z: 0});
AFRAME.utils.entity.setComponentProperty(card4, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card4, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card4, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card5, "position", {x: 0, y: 0.58, z: 0});
AFRAME.utils.entity.setComponentProperty(card5, "rotation", {x: 0, y: 2, z: 0});
AFRAME.utils.entity.setComponentProperty(card5, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card5, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card5, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card6, "position", {x: 0, y: 0.6, z: 0});
AFRAME.utils.entity.setComponentProperty(card6, "rotation", {x: 0, y: 3, z: 0});
AFRAME.utils.entity.setComponentProperty(card6, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card6, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card6, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card7, "position", {x: 0, y: 0.62, z: 0});
AFRAME.utils.entity.setComponentProperty(card7, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card7, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card7, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card8, "position", {x: 0, y: 0.64, z: 0});
AFRAME.utils.entity.setComponentProperty(card8, "rotation", {x: 0, y: 5, z: 0});
AFRAME.utils.entity.setComponentProperty(card8, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card8, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card8, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card9, "position", {x: 0, y: 0.66, z: 0});
AFRAME.utils.entity.setComponentProperty(card9, "rotation", {x: 0, y: 4, z: 0});
AFRAME.utils.entity.setComponentProperty(card9, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card9, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card9, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card10, "position", {x: 0, y: 0.68, z: 0});
AFRAME.utils.entity.setComponentProperty(card10, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card10, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card10, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card11, "position", {x: 0, y: 0.7, z: 0});
AFRAME.utils.entity.setComponentProperty(card11, "rotation", {x: 0, y: 1, z: 0});
AFRAME.utils.entity.setComponentProperty(card11, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card11, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card11, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card12, "position", {x: 0, y: 0.72, z: 0});
AFRAME.utils.entity.setComponentProperty(card12, "rotation", {x: 0, y: 3, z: 0});
AFRAME.utils.entity.setComponentProperty(card12, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card12, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card12, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card13, "position", {x: 0, y: 0.74, z: 0});
AFRAME.utils.entity.setComponentProperty(card13, "rotation", {x: 0, y: 5, z: 0});
AFRAME.utils.entity.setComponentProperty(card13, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card13, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card13, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card14, "position", {x: 0, y: 0.76, z: 0});
AFRAME.utils.entity.setComponentProperty(card14, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card14, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card14, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card15, "position", {x: 0, y: 0.78, z: 0});
AFRAME.utils.entity.setComponentProperty(card15, "rotation", {x: 0, y: 3, z: 0});
AFRAME.utils.entity.setComponentProperty(card15, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card15, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card15, "material", "color: white");

AFRAME.utils.entity.setComponentProperty(card16, "position", {x: 0, y: 0.8, z: 0});
AFRAME.utils.entity.setComponentProperty(card16, "rotation", {x: 0, y: 5, z: 0});
AFRAME.utils.entity.setComponentProperty(card16, "geometry", "primitive: box");
AFRAME.utils.entity.setComponentProperty(card16, "scale", {x: 0.17, y: 0.02, z: 0.1});
AFRAME.utils.entity.setComponentProperty(card16, "material", "color: white");
AFRAME.utils.entity.setComponentProperty(card16, "id", "cardStack");
AFRAME.utils.entity.setComponentProperty(card16, "class", "clickableTrigger");

memoryEntity.appendChild(card1);
memoryEntity.appendChild(card2);
memoryEntity.appendChild(card3);
memoryEntity.appendChild(card4);
memoryEntity.appendChild(card5);
memoryEntity.appendChild(card6);
memoryEntity.appendChild(card7);
memoryEntity.appendChild(card8);
memoryEntity.appendChild(card9);
memoryEntity.appendChild(card10);
memoryEntity.appendChild(card11);
memoryEntity.appendChild(card12);
memoryEntity.appendChild(card13);
memoryEntity.appendChild(card14);
memoryEntity.appendChild(card15);
memoryEntity.appendChild(card16);


// memory game
// some of this is adapted from https://codepen.io/natewiley/pen/HBrbL
var tries = 0;
var count = 0;
var matches = 0;
var foundCards = [];
var tempFoundCards = [];

var memoryCards = [
    document.querySelector("#memoryCard1"),
    document.querySelector("#memoryCard2"),
    document.querySelector("#memoryCard3"),
    document.querySelector("#memoryCard4"),
    document.querySelector("#memoryCard5"),
    document.querySelector("#memoryCard6"),
    document.querySelector("#memoryCard7"),
    document.querySelector("#memoryCard8"),
    document.querySelector("#memoryCard9"),
    document.querySelector("#memoryCard10"),
    document.querySelector("#memoryCard11"),
    document.querySelector("#memoryCard12"),
    document.querySelector("#memoryCard13"),
    document.querySelector("#memoryCard14"),
    document.querySelector("#memoryCard15"),
    document.querySelector("#memoryCard16")
];

var cards = [
    document.querySelector("#mcard1"),
    document.querySelector("#mcard2"),
    document.querySelector("#mcard3"),
    document.querySelector("#mcard4"),
    document.querySelector("#mcard5"),
    document.querySelector("#mcard6"),
    document.querySelector("#mcard7"),
    document.querySelector("#mcard8"),
    document.querySelector("#mcard9"),
    document.querySelector("#mcard10"),
    document.querySelector("#mcard11"),
    document.querySelector("#mcard12"),
    document.querySelector("#mcard13"),
    document.querySelector("#mcard14"),
    document.querySelector("#mcard15"),
    document.querySelector("#mcard16")
];

var images = [
    {
        name: "html5",
        img: "../assets/icons/html5-logo.png"
    },
    {
        name: "html5",
        img: "../assets/icons/html5-logo.png"
    },
    {
        name: "autodesk",
        img: "../assets/icons/autodesk_logo.png"
    },
    {
        name: "autodesk",
        img: "../assets/icons/autodesk_logo.png"
    },
    {
        name: "github",
        img: "../assets/icons/github-logo.png"
    },
    {
        name: "github",
        img: "../assets/icons/github-logo.png"
    },
    {
        name: "css3",
        img: "../assets/icons/css3-logo.png"
    },
    {
        name: "css3",
        img: "../assets/icons/css3-logo.png"
    },
    {
        name: "slack",
        img: "../assets/icons/slack-logo.png"
    },
    {
        name: "slack",
        img: "../assets/icons/slack-logo.png"
    },
    {
        name: "aframe",
        img: "../assets/icons/aframe-logo.png"
    },
    {
        name: "aframe",
        img: "../assets/icons/aframe-logo.png"
    },
    {
        name: "nodejs",
        img: "../assets/icons/nodejs-logo.png"
    },
    {
        name: "nodejs",
        img: "../assets/icons/nodejs-logo.png"
    },
    {
        name: "jquery",
        img: "../assets/icons/jquery-logo.png"
    },
    {
        name: "jquery",
        img: "../assets/icons/jquery-logo.png"
    }
];

var memoryVisible = false;
var turnCardEvent = false;

/** Check game status and show memory game, if no other game is in progress */
var memory = document.querySelector("#memoryGame");
$("#cardStack").on("click", function triggerMemory() {
    if(checkGameStatus(games[2])!==false){
        if (memoryVisible === false) {

            //#SpielaufrufGrossvater
            document.querySelector("#containerGroßvaterGame" + ' > a-sound' ).emit("Spielaufruf");
            document.querySelector("#containerGroßvaterGame" + ' > a-animation' ).emit("Spielaufruf");

            AFRAME.utils.entity.setComponentProperty(memory, "visible", true);
            memoryVisible = true;
            gameActive = "#memoryGame";
        }
        else {
            AFRAME.utils.entity.setComponentProperty(memory, "visible", false);
            memoryVisible = false;
        }
    }
});

/** Generate new memory game, if no other game is in progress */
$("#cardStack").on("click", function () {
    if(checkGameStatus(games[2])!==false){
        buildMemory(cards, images, memoryCards);
    }
});

function isInArray(value, array) {
    return array.indexOf(value) > -1;
}

function wait(on) {
    document.querySelector(on).addEventListener('animationend', function (evt) {
        console.log(on + ' ->This Animation is done');
    });
}


var ready = true;
var first, firstImage, firstCard, firstCardEntity,
    second, secondImage, secondCard, secondCardEntity,
    triggerEvent;
function removeFromArray(temp) {
    if(temp != -1) {
        foundCards.splice(temp, 1);
    }
}


$(".memoryCard").on("click", function turnCard() {
    if (ready === true) {
        var foundcard = "#" + $(this).closest("a-box").attr("id");
        console.log(isInArray(foundcard, foundCards));

        if (isInArray(foundcard, foundCards) === false && tempFoundCards.length < 2) {

            var card = foundcard;
            var cardEntity = document.querySelector(card);
            var imageId = "#" + $(this).closest("a-box").children("a-image").attr("id");
            var imageEntity = document.querySelector(imageId);
            var cardType = "#" + $(this).closest("a-box").children("a-image").attr("name");

            //    if (!isInArray(card, foundCards) && tempFoundCards.length < 2) {
            foundCards.push(card);
            tempFoundCards.push(card);
            if (tries === 0) {
                tries = 1;
                first = cardType;
                firstImage = imageEntity;
                firstCard = card;
                firstCardEntity = cardEntity;
                console.log("First: " + first);


                triggerEvent = "turnCard";
                document.querySelector(card).emit(triggerEvent);
                setTimeout(function colorAndVisibleTurn() {
                    AFRAME.utils.entity.setComponentProperty(cardEntity, "color", "white");
                    AFRAME.utils.entity.setComponentProperty(imageEntity, "visible", "true");
                }, 1200);
            }
            else if (tries == 1 && card != firstCard) {
                ready = false;
                tries = 0;
                second = cardType;
                secondImage = imageEntity;
                secondCard = card;
                secondCardEntity = cardEntity;
                console.log("Second: " + second);


                triggerEvent = "turnCard";
                document.querySelector(card).emit(triggerEvent);
                setTimeout(function colorAndVisibleTurn() {
                    AFRAME.utils.entity.setComponentProperty(cardEntity, "color", "white");
                    AFRAME.utils.entity.setComponentProperty(imageEntity, "visible", "true");
                }, 1200);

                if (first == second) {
                    matches++;
                }
                else {
                    var tempFirst = first,
                        tempFirstImage = firstImage,
                        tempFirstCard = firstCard,
                        tempFirstCardEntity = firstCardEntity,
                        tempSecond = second,
                        tempSecondImage = secondImage,
                        tempSecondCard = secondCard,
                        tempSecondCardEntity = secondCardEntity,
                        tempTriggerEvent = triggerEvent;

                    setTimeout(function triggerTurnCard() {
                        console.log("foundCards: "+ foundCards);

                        var temp1 = foundCards.indexOf(tempFirstCard);
                        removeFromArray(temp1);
                        var temp2 = foundCards.indexOf(tempSecondCard);
                        removeFromArray(temp2);

                        console.log("foundCards: "+ foundCards);
                        document.querySelector(tempFirstCard).emit(tempTriggerEvent);
                        document.querySelector(tempSecondCard).emit(tempTriggerEvent);
                        turnCardEvent = false;

                        setTimeout(function colorAndVisibleForFound() {
                            AFRAME.utils.entity.setComponentProperty(tempFirstImage, "visible", false);
                            AFRAME.utils.entity.setComponentProperty(tempSecondImage, "visible", false);
                            AFRAME.utils.entity.setComponentProperty(tempFirstCardEntity, "color", "#eb2348");
                            AFRAME.utils.entity.setComponentProperty(tempSecondCardEntity, "color", "#eb2348");

                        }, 1200);
                    }, 3500);
                }
                console.log("tempFoundCards: " + tempFoundCards);
                for (var ii = 0; ii < tempFoundCards.length; ii++) {
                    wait(tempFoundCards[ii]);
                }
                tempFoundCards=[];
                ready = true;

            }
            if (matches == 1) {
                console.log("Hurra!");
                matches = 0;
            }

            if (foundCards.length == cards.length) {
                console.log("Hip Hip Hurra!");
            }
        }
    }
});

/**
 * Generate new memory game based on given parameters
 * @param {array} cards - array of entities already set in the html
 * @param {array} images - array of images to set as background images
 * @param {memoryCards} memoryCards - array of entities to set the background images on
 */
function buildMemory(cards, images, memoryCards) {
    foundCards = [];
    randomizeImages();

    for (var iii = 0, jjj = 0; iii, jjj < cards.length; iii++, jjj++) {
        var memoryCard = memoryCards[iii];
        console.log(memoryCard);
        var buildCard = cards[iii];
        var image = images[jjj];
        AFRAME.utils.entity.setComponentProperty(memoryCard, "color", "#eb2348");
        AFRAME.utils.entity.setComponentProperty(buildCard, "visible", false);
        AFRAME.utils.entity.setComponentProperty(buildCard, "src", image.img);
        AFRAME.utils.entity.setComponentProperty(buildCard, "id", "m-image" + iii);
        AFRAME.utils.entity.setComponentProperty(buildCard, "name", image.name);
    }

    // randomize array of images
    function randomizeImages(){
        Array.prototype.randomize = function()
        {
            var i = this.length, j, temp;
            while ( --i )
            {
                j = Math.floor( Math.random() * (i - 1) );
                temp = this[i];
                this[i] = this[j];
                this[j] = temp;
            }
        };
        images.randomize();
    }
}
